<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calidra">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23E63946' rx='40'/%3E%3Ctext x='90' y='125' font-family='Arial, sans-serif' font-size='95' font-weight='900' fill='white' text-anchor='middle'%3EC%3C/text%3E%3C/svg%3E">
    <title>Cotizador Calidra</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700;900&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --primary: #E63946;
            --primary-dark: #C72C3B;
            --secondary: #1D3557;
            --accent: #F77F00;
            --bg: #F8F9FA;
            --surface: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6C757D;
            --border: #DEE2E6;
            --success: #06D6A0;
            --shadow: rgba(0, 0, 0, 0.08);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 3px solid var(--primary);
            padding: 1.5rem 1.25rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: white;
            font-size: 1.25rem;
            letter-spacing: -1px;
        }
        
        .logo-text {
            font-weight: 900;
            font-size: 1.5rem;
            color: var(--secondary);
            letter-spacing: -0.5px;
        }
        
        .version {
            background: var(--accent);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Container */
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 1.5rem 1.25rem;
        }
        
        /* Card */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--bg);
        }
        
        .card-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--secondary);
            letter-spacing: -0.3px;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--surface);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.1);
        }
        
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%231D3557' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 3rem;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-prefix {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .input-with-prefix {
            padding-left: 2.5rem;
        }
        
        /* Search Container */
        .search-container {
            position: relative;
        }
        
        .search-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            pointer-events: none;
            opacity: 0.5;
        }
        
        .search-results {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-item:hover {
            background: rgba(230, 57, 70, 0.05);
        }
        
        .search-result-item.active {
            background: rgba(230, 57, 70, 0.1);
        }
        
        .search-result-name {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }
        
        .search-result-sitio {
            background: linear-gradient(135deg, rgba(247, 127, 0, 0.1), rgba(230, 57, 70, 0.1));
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-primary);
            margin: 0.4rem 0;
            border-left: 3px solid var(--accent);
        }
        
        .search-result-sitio strong {
            color: var(--accent);
            font-weight: 700;
        }
        
        .search-result-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .search-result-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .search-result-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-exw {
            background: rgba(6, 214, 160, 0.15);
            color: var(--success);
        }
        
        .badge-dap {
            background: rgba(247, 127, 0, 0.15);
            color: var(--accent);
        }
        
        .badge-preferente {
            background: rgba(230, 57, 70, 0.15);
            color: var(--primary);
        }
        
        .badge-activo {
            background: rgba(29, 53, 87, 0.15);
            color: var(--secondary);
        }
        
        .no-results {
            padding: 2rem 1rem;
            text-align: center;
            color: var(--text-secondary);
        }
        
        .no-results-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.3;
        }
        
        .no-results-text {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .no-results-hint {
            font-size: 0.85rem;
        }
        
        /* Client Info Card */
        .client-info-card {
            background: linear-gradient(135deg, rgba(230, 57, 70, 0.05), rgba(247, 127, 0, 0.05));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .client-info-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(230, 57, 70, 0.2);
        }
        
        .client-info-icon {
            font-size: 1.5rem;
        }
        
        .client-info-title {
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .client-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .client-info-item {
            background: var(--surface);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .client-info-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .client-info-value {
            display: block;
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Radio Buttons */
        .radio-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .radio-option {
            position: relative;
        }
        
        .radio-input {
            position: absolute;
            opacity: 0;
        }
        
        .radio-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--surface);
            min-height: 90px;
        }
        
        .radio-input:checked + .radio-label {
            border-color: var(--primary);
            background: rgba(230, 57, 70, 0.05);
        }
        
        .radio-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .radio-text {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            text-align: center;
        }
        
        .radio-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            text-align: center;
        }
        
        /* Button */
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
        }
        
        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(230, 57, 70, 0.3);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--secondary);
            border: 2px solid var(--border);
        }
        
        /* Preview */
        .preview {
            background: var(--bg);
            border-radius: 12px;
            padding: 1.25rem;
            border: 2px dashed var(--border);
        }
        
        .preview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .preview-row:last-child {
            border-bottom: none;
            padding-top: 1rem;
            margin-top: 0.5rem;
        }
        
        .preview-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .preview-value {
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .preview-total {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .alert-success {
            background: rgba(6, 214, 160, 0.1);
            border: 2px solid var(--success);
            color: var(--text-primary);
        }
        
        .alert-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .alert-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        /* Hidden */
        .hidden {
            display: none;
        }
        
        /* Loading Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            background: var(--secondary);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            z-index: 200;
        }
        
        .install-prompt-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .install-prompt-content {
            flex: 1;
        }
        
        .install-prompt-title {
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .install-prompt-desc {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .install-prompt-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">C</div>
                <span class="logo-text">CALIDRA</span>
            </div>
            <span class="version">v1.0</span>
        </div>
    </header>
    
    <!-- Main Container -->
    <div class="container">
        <!-- Form Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üìã</div>
                <h2 class="card-title">Nueva Cotizaci√≥n</h2>
            </div>
            
            <form id="quoteForm">
                <!-- B√∫squeda de Cliente -->
                <div class="form-group">
                    <label class="form-label">Buscar Cliente</label>
                    <div class="search-container">
                        <input type="text" class="form-input" id="clientSearch" placeholder="Escribe nombre, RFC o palabra clave..." autocomplete="off">
                        <div class="search-icon">üîç</div>
                        <div class="search-results hidden" id="searchResults"></div>
                    </div>
                </div>
                
                <!-- Informaci√≥n del Cliente (auto-llenado) -->
                <div class="client-info-card hidden" id="clientInfoCard">
                    <div class="client-info-header">
                        <span class="client-info-icon">üë§</span>
                        <span class="client-info-title">Informaci√≥n del Cliente</span>
                    </div>
                    <div class="client-info-grid">
                        <div class="client-info-item">
                            <span class="client-info-label">Cuenta:</span>
                            <span class="client-info-value" id="displayRFC">-</span>
                        </div>
                        <div class="client-info-item">
                            <span class="client-info-label">Zona:</span>
                            <span class="client-info-value" id="displayZona">-</span>
                        </div>
                        <div class="client-info-item">
                            <span class="client-info-label">Sub-zona:</span>
                            <span class="client-info-value" id="displaySubzona">-</span>
                        </div>
                        <div class="client-info-item">
                            <span class="client-info-label">Sitio:</span>
                            <span class="client-info-value" id="displaySitio">-</span>
                        </div>
                        <div class="client-info-item">
                            <span class="client-info-label">Segmento:</span>
                            <span class="client-info-value" id="displaySegmento">-</span>
                        </div>
                        <div class="client-info-item">
                            <span class="client-info-label">Modalidad:</span>
                            <span class="client-info-value" id="displayModalidad">-</span>
                        </div>
                        <div class="client-info-item" style="grid-column: 1 / -1;">
                            <span class="client-info-label">Representante:</span>
                            <span class="client-info-value" id="displayRepresentante">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden fields para el formulario -->
                <input type="hidden" id="clientName">
                <input type="hidden" id="clientRFC">
                <input type="hidden" id="clientLocation">
                <input type="hidden" id="clientZona">
                <input type="hidden" id="clientSubzona">
                <input type="hidden" id="clientSitio">
                <input type="hidden" id="clientSegmento">
                <input type="hidden" id="clientRepresentante">
                
                <!-- Cantidad -->
                <div class="form-group">
                    <label class="form-label">Cantidad (Toneladas)</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="quantity" placeholder="0" min="0" step="0.01" required>
                    </div>
                </div>
                
                <!-- Modalidad -->
                <div class="form-group">
                    <label class="form-label">Modalidad de Entrega</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="modalityEXW" name="modality" value="EXW" checked>
                            <label class="radio-label" for="modalityEXW">
                                <div class="radio-icon">üè≠</div>
                                <div class="radio-text">EXW</div>
                                <div class="radio-desc">Recoger en planta</div>
                            </label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" class="radio-input" id="modalityDAP" name="modality" value="DAP">
                            <label class="radio-label" for="modalityDAP">
                                <div class="radio-icon">üöö</div>
                                <div class="radio-text">DAP</div>
                                <div class="radio-desc">Entrega domicilio</div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Precio Unitario -->
                <div class="form-group">
                    <label class="form-label">Precio Unitario</label>
                    <div class="input-group">
                        <span class="input-prefix">$</span>
                        <input type="number" class="form-input input-with-prefix" id="unitPrice" placeholder="0.00" min="0" step="0.01" required>
                    </div>
                </div>
                
                <!-- Preview -->
                <div class="preview">
                    <div class="preview-row">
                        <span class="preview-label">Subtotal</span>
                        <span class="preview-value" id="previewSubtotal">$0.00</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">IVA (16%)</span>
                        <span class="preview-value" id="previewIVA">$0.00</span>
                    </div>
                    <div class="preview-row">
                        <span class="preview-label">Total</span>
                        <span class="preview-value preview-total" id="previewTotal">$0.00</span>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary" style="margin-top: 1.5rem;">
                    ‚ú® Generar Cotizaci√≥n
                </button>
            </form>
        </div>
        
        <!-- Success Alert (Hidden by default) -->
        <div class="alert alert-success hidden" id="successAlert">
            <div class="alert-icon">‚úÖ</div>
            <div class="alert-content">
                <div class="alert-title">¬°Cotizaci√≥n generada!</div>
                <div class="alert-message">El documento PDF est√° listo para descarga.</div>
            </div>
        </div>
    </div>
    
    <!-- Install Prompt (Hidden by default) -->
    <div class="install-prompt hidden" id="installPrompt">
        <div class="install-prompt-icon">üì±</div>
        <div class="install-prompt-content">
            <div class="install-prompt-title">Instalar aplicaci√≥n</div>
            <div class="install-prompt-desc">Accede m√°s r√°pido desde tu pantalla de inicio</div>
        </div>
        <button class="install-prompt-close" id="closeInstallPrompt">√ó</button>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Cliente database
        let clientDatabase = [];
        let selectedClient = null;
        
        // Load client database
        fetch('./clientes_db.json')
            .then(response => response.json())
            .then(data => {
                clientDatabase = data;
                console.log(`Loaded ${clientDatabase.length} clients`);
            })
            .catch(error => {
                console.error('Error loading client database:', error);
            });
        
        // Form elements
        const form = document.getElementById('quoteForm');
        const quantityInput = document.getElementById('quantity');
        const unitPriceInput = document.getElementById('unitPrice');
        const clientSearchInput = document.getElementById('clientSearch');
        const searchResults = document.getElementById('searchResults');
        const successAlert = document.getElementById('successAlert');
        
        // Preview elements
        const previewSubtotal = document.getElementById('previewSubtotal');
        const previewIVA = document.getElementById('previewIVA');
        const previewTotal = document.getElementById('previewTotal');
        
        // Search functionality
        let searchTimeout;
        let currentSearchIndex = -1;
        let currentSearchResults = [];
        
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "")
                .trim();
        }
        
        function searchClients(query) {
            if (!query || query.length < 2) {
                return [];
            }
            
            const normalizedQuery = normalizeText(query);
            const modality = document.querySelector('input[name="modality"]:checked').value;
            
            // Search in name, RFC, and zone
            const results = clientDatabase.filter(client => {
                const matchesModality = client.modo_entrega === modality;
                const matchesName = normalizeText(client.nombre).includes(normalizedQuery);
                const matchesRFC = normalizeText(client.rfc).includes(normalizedQuery);
                const matchesZone = normalizeText(client.zona).includes(normalizedQuery);
                
                return matchesModality && (matchesName || matchesRFC || matchesZone);
            });
            
            // NO eliminar duplicados - cada sitio es una opci√≥n diferente
            // Crear una clave √∫nica por RFC + Sitio + Modalidad
            const uniqueResults = [];
            const seenKeys = new Set();
            
            results.forEach(client => {
                const key = `${client.rfc}-${client.sitio}-${client.modo_entrega}`;
                if (!seenKeys.has(key)) {
                    seenKeys.add(key);
                    uniqueResults.push(client);
                }
            });
            
            // Sort by relevance (exact name match first, then by sitio)
            uniqueResults.sort((a, b) => {
                const aNameMatch = normalizeText(a.nombre).startsWith(normalizedQuery);
                const bNameMatch = normalizeText(b.nombre).startsWith(normalizedQuery);
                
                if (aNameMatch && !bNameMatch) return -1;
                if (!aNameMatch && bNameMatch) return 1;
                
                // Si tienen el mismo nombre, ordenar por sitio
                const nameCompare = a.nombre.localeCompare(b.nombre);
                if (nameCompare !== 0) return nameCompare;
                
                return a.sitio.localeCompare(b.sitio);
            });
            
            return uniqueResults.slice(0, 50); // Limit to 50 results (para ver todos los sitios)
        }
        
        function displaySearchResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <div class="no-results-text">No se encontraron clientes</div>
                        <div class="no-results-hint">Intenta con otro nombre o palabra clave</div>
                    </div>
                `;
                searchResults.classList.remove('hidden');
                return;
            }
            
            currentSearchResults = results;
            currentSearchIndex = -1;
            
            const html = results.map((client, index) => `
                <div class="search-result-item" data-index="${index}">
                    <div class="search-result-name">${client.nombre}</div>
                    <div class="search-result-sitio">üè≠ Sitio: <strong>${client.sitio}</strong></div>
                    <div class="search-result-details">
                        <span class="search-result-detail">
                            <span>üìã</span> ${client.rfc}
                        </span>
                        <span class="search-result-detail">
                            <span>üìç</span> ${client.zona}
                        </span>
                        <span class="search-result-badge badge-${client.modo_entrega.toLowerCase()}">${client.modo_entrega}</span>
                        <span class="search-result-badge badge-${client.segmento.toLowerCase().replace(' ', '-')}">${client.segmento}</span>
                        <span class="search-result-detail" style="font-weight: 700; color: var(--primary);">
                            <span>üí∞</span> $${client.precio.toLocaleString('es-MX', {minimumFractionDigits: 2})}
                        </span>
                    </div>
                </div>
            `).join('');
            
            searchResults.innerHTML = html;
            searchResults.classList.remove('hidden');
            
            // Add click handlers
            searchResults.querySelectorAll('.search-result-item').forEach((item, index) => {
                item.addEventListener('click', () => selectClient(results[index]));
            });
        }
        
        function selectClient(client) {
            selectedClient = client;
            
            // Fill hidden form fields
            document.getElementById('clientName').value = client.nombre;
            document.getElementById('clientRFC').value = client.rfc;
            document.getElementById('clientLocation').value = client.zona;
            document.getElementById('clientZona').value = client.zona;
            document.getElementById('clientSubzona').value = client.subzona || 'N/A';
            document.getElementById('clientSitio').value = client.sitio;
            document.getElementById('clientSegmento').value = client.segmento;
            document.getElementById('clientRepresentante').value = client.representante || 'N/A';
            unitPriceInput.value = client.precio.toFixed(2);
            clientSearchInput.value = client.nombre;
            
            // Display client info card
            const clientInfoCard = document.getElementById('clientInfoCard');
            document.getElementById('displayRFC').textContent = client.rfc;
            document.getElementById('displayZona').textContent = client.zona;
            document.getElementById('displaySubzona').textContent = client.subzona || 'N/A';
            document.getElementById('displaySitio').textContent = client.sitio;
            document.getElementById('displaySegmento').textContent = client.segmento;
            document.getElementById('displayModalidad').textContent = client.modo_entrega;
            document.getElementById('displayRepresentante').textContent = client.representante || 'N/A';
            
            clientInfoCard.classList.remove('hidden');
            
            // Hide search results
            searchResults.classList.add('hidden');
            
            // Update preview
            updatePreview();
            
            // Show success feedback
            clientSearchInput.style.borderColor = 'var(--success)';
            setTimeout(() => {
                clientSearchInput.style.borderColor = '';
            }, 1000);
        }
        
        // Search input handler
        clientSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            if (clientDatabase.length === 0) {
                searchResults.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">‚è≥</div>
                        <div class="no-results-text">Cargando base de datos...</div>
                    </div>
                `;
                searchResults.classList.remove('hidden');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                const results = searchClients(query);
                displaySearchResults(results);
            }, 300);
        });
        
        // Keyboard navigation
        clientSearchInput.addEventListener('keydown', function(e) {
            if (searchResults.classList.contains('hidden') || currentSearchResults.length === 0) {
                return;
            }
            
            const items = searchResults.querySelectorAll('.search-result-item');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                currentSearchIndex = Math.min(currentSearchIndex + 1, items.length - 1);
                updateActiveItem(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                currentSearchIndex = Math.max(currentSearchIndex - 1, -1);
                updateActiveItem(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentSearchIndex >= 0 && currentSearchIndex < currentSearchResults.length) {
                    selectClient(currentSearchResults[currentSearchIndex]);
                }
            } else if (e.key === 'Escape') {
                searchResults.classList.add('hidden');
            }
        });
        
        function updateActiveItem(items) {
            items.forEach((item, index) => {
                if (index === currentSearchIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // Click outside to close
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.add('hidden');
            }
        });
        
        // Modality change - trigger new search
        document.querySelectorAll('input[name="modality"]').forEach(radio => {
            radio.addEventListener('change', function() {
                selectedClient = null;
                document.getElementById('clientName').value = '';
                document.getElementById('clientRFC').value = '';
                document.getElementById('clientLocation').value = '';
                document.getElementById('clientZona').value = '';
                document.getElementById('clientSubzona').value = '';
                document.getElementById('clientSitio').value = '';
                document.getElementById('clientSegmento').value = '';
                document.getElementById('clientRepresentante').value = '';
                unitPriceInput.value = '';
                
                // Hide client info card
                document.getElementById('clientInfoCard').classList.add('hidden');
                
                // Re-search if there's a query
                const query = clientSearchInput.value.trim();
                if (query.length >= 2) {
                    const results = searchClients(query);
                    displaySearchResults(results);
                }
                
                updatePreview();
            });
        });
        
        // Update preview on input
        function updatePreview() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            
            const subtotal = quantity * unitPrice;
            const iva = subtotal * 0.16;
            const total = subtotal + iva;
            
            previewSubtotal.textContent = `$${subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            previewIVA.textContent = `$${iva.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            previewTotal.textContent = `$${total.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        quantityInput.addEventListener('input', updatePreview);
        unitPriceInput.addEventListener('input', updatePreview);
        
        // Generate PDF function
        function generatePDF(formData) {
            console.log('üé® Starting PDF generation');
            
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            console.log('üìã jsPDF initialized');
            
            // Set font
            doc.setFont("helvetica");
            
            // ========== HEADER ==========
            // Red background bar
            doc.setFillColor(230, 57, 70);
            doc.rect(0, 0, 210, 35, 'F');
            
            // Logo and company name
            doc.setFontSize(32);
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.text("CALIDRA", 15, 22);
            
            // Tagline
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text("SIEMPRE AQU√ç", 15, 28);
            
            // Document info box (sin n√∫mero de cotizaci√≥n)
            doc.setFillColor(255, 255, 255);
            doc.roundedRect(150, 10, 50, 15, 2, 2, 'F');
            
            doc.setTextColor(230, 57, 70);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text("COTIZACI√ìN", 175, 16, { align: 'center' });
            
            doc.setTextColor(80, 80, 80);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.text(`Fecha: ${formData.date}`, 175, 21, { align: 'center' });
            
            // ========== CLIENT SECTION ==========
            let yPos = 45;
            
            // "PARA:" label
            doc.setFillColor(29, 53, 87);
            doc.rect(15, yPos, 25, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.text("PARA:", 27.5, yPos + 5, { align: 'center' });
            
            // Client info box
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.5);
            doc.roundedRect(15, yPos + 9, 180, 40, 2, 2, 'S');
            
            yPos += 14;
            doc.setTextColor(40, 40, 40);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text(formData.clientName, 20, yPos);
            
            // Client details in two columns
            yPos += 6;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            
            // Left column
            doc.text("Cuenta:", 20, yPos);
            doc.setTextColor(40, 40, 40);
            doc.text(formData.clientRFC, 38, yPos);
            
            doc.setTextColor(100, 100, 100);
            doc.text("Zona:", 20, yPos + 5);
            doc.setTextColor(40, 40, 40);
            doc.text(formData.clientZona, 38, yPos + 5);
            
            doc.setTextColor(100, 100, 100);
            doc.text("Sub-zona:", 20, yPos + 10);
            doc.setTextColor(40, 40, 40);
            doc.text(formData.clientSubzona, 38, yPos + 10);
            
            // Right column
            doc.setTextColor(100, 100, 100);
            doc.text("Sitio:", 105, yPos);
            doc.setTextColor(40, 40, 40);
            doc.text(formData.clientSitio, 118, yPos);
            
            doc.setTextColor(100, 100, 100);
            doc.text("Segmento:", 105, yPos + 5);
            doc.setTextColor(40, 40, 40);
            doc.text(formData.clientSegmento, 118, yPos + 5);
            
            doc.setTextColor(100, 100, 100);
            doc.text("Modalidad:", 105, yPos + 10);
            doc.setTextColor(40, 40, 40);
            const modalityText = formData.modality === 'EXW' ? 'EXW - Recoger en Planta' : 'DAP - Entrega a Domicilio';
            doc.text(modalityText, 118, yPos + 10);
            
            // Representante (full width)
            yPos += 15;
            doc.setTextColor(100, 100, 100);
            doc.text("Representante de Ventas:", 20, yPos);
            doc.setTextColor(40, 40, 40);
            doc.setFont("helvetica", "bold");
            doc.text(formData.clientRepresentante, 55, yPos);
            
            // ========== PRODUCT TABLE ==========
            yPos = 103;
            
            // Table header
            doc.setFillColor(230, 57, 70);
            doc.rect(15, yPos, 180, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.text("CANTIDAD", 20, yPos + 6.5);
            doc.text("PRODUCTO", 60, yPos + 6.5);
            doc.text("PRECIO UNIT.", 140, yPos + 6.5);
            doc.text("TOTAL", 175, yPos + 6.5);
            
            // Table row
            yPos += 10;
            doc.setDrawColor(220, 220, 220);
            doc.line(15, yPos, 195, yPos);
            
            yPos += 6;
            doc.setTextColor(40, 40, 40);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text(`${formData.quantity} Ton`, 20, yPos);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text("Hidr√≥xido de Calcio", 60, yPos);
            doc.setFontSize(7);
            doc.setTextColor(100, 100, 100);
            doc.text("Envasado en sacos de 25 kg", 60, yPos + 4);
            
            doc.setTextColor(40, 40, 40);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.text(`$${formData.unitPrice.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 140, yPos);
            
            doc.setFont("helvetica", "bold");
            doc.text(`$${formData.subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 175, yPos);
            
            // ========== TOTALS SECTION ==========
            yPos += 15;
            doc.setDrawColor(220, 220, 220);
            doc.line(15, yPos, 195, yPos);
            
            yPos += 8;
            
            // Subtotal
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            doc.setTextColor(80, 80, 80);
            doc.text("Subtotal:", 140, yPos);
            doc.setTextColor(40, 40, 40);
            doc.text(`$${formData.subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 175, yPos);
            
            // IVA
            yPos += 6;
            doc.setTextColor(80, 80, 80);
            doc.text("IVA (16%):", 140, yPos);
            doc.setTextColor(40, 40, 40);
            doc.text(`$${formData.iva.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 175, yPos);
            
            // Total box
            yPos += 8;
            doc.setFillColor(230, 57, 70);
            doc.roundedRect(130, yPos - 4, 65, 10, 2, 2, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text("TOTAL:", 140, yPos + 2.5);
            doc.setFontSize(12);
            doc.text(`$${formData.total.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 175, yPos + 2.5);
            
            // ========== NOTES SECTION ==========
            yPos += 20;
            
            doc.setFillColor(247, 127, 0);
            doc.rect(15, yPos, 4, 6, 'F');
            
            doc.setTextColor(40, 40, 40);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text("NOTAS IMPORTANTES:", 22, yPos + 4.5);
            
            yPos += 10;
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(80, 80, 80);
            
            // Nota din√°mica seg√∫n sitio y modalidad
            let deliveryNote = '';
            if (formData.modality === 'EXW') {
                deliveryNote = `‚Ä¢ Precio para recoger en: ${formData.clientSitio}`;
            } else {
                deliveryNote = `‚Ä¢ Precio incluye entrega desde: ${formData.clientSitio} al domicilio registrado`;
            }
            
            doc.text(deliveryNote, 20, yPos);
            doc.text('‚Ä¢ Las programaciones deben ser con anticipaci√≥n m√≠nima de 72 horas', 20, yPos + 5);
            doc.text('  (una vez confirmado el pago en firme)', 20, yPos + 9);
            doc.text('‚Ä¢ La factura se genera con respecto al peso en la remisi√≥n', 20, yPos + 14);
            
            // ========== FOOTER ==========
            yPos = 270;
            
            // Decorative line
            doc.setDrawColor(230, 57, 70);
            doc.setLineWidth(1);
            doc.line(15, yPos, 195, yPos);
            
            // Footer text
            yPos += 5;
            doc.setFont("helvetica", "italic");
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text("Sin m√°s por el momento, quedamos al pendiente de sus comentarios,", 105, yPos, { align: 'center' });
            doc.text("ofreci√©ndoles nuestros servicios y productos de m√°s alta calidad.", 105, yPos + 3.5, { align: 'center' });
            
            yPos += 10;
            doc.setFontSize(6);
            doc.setTextColor(180, 180, 180);
            doc.text("Documento generado autom√°ticamente por el Sistema de Cotizaciones Calidra", 105, yPos, { align: 'center' });
            doc.text(`Generado: ${new Date().toLocaleString('es-MX')}`, 105, yPos + 3, { align: 'center' });
            
            // Save PDF - sin n√∫mero de cotizaci√≥n en el nombre
            const fileName = `Cotizacion_${formData.clientRFC}_${formData.date.replace(/\//g, '-')}.pdf`;
            doc.save(fileName);
        }
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üìù Form submit triggered');
            
            // Validar que se haya seleccionado un cliente
            const clientName = document.getElementById('clientName').value;
            const clientRFC = document.getElementById('clientRFC').value;
            
            if (!clientName || !clientRFC) {
                alert('‚ö†Ô∏è Por favor busca y selecciona un cliente antes de generar la cotizaci√≥n');
                return;
            }
            
            // Validar cantidad
            const quantity = parseFloat(quantityInput.value);
            if (!quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor ingresa una cantidad v√°lida');
                quantityInput.focus();
                return;
            }
            
            const formData = {
                clientName: clientNameInput.value,
                clientRFC: clientRFCInput.value.toUpperCase(),
                clientLocation: clientLocationInput.value,
                quantity: parseFloat(quantityInput.value),
                unitPrice: parseFloat(unitPriceInput.value),
                modality: document.querySelector('input[name="modality"]:checked').value,
                date: new Date().toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }),
                quoteNumber: 'GE-' + String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0')
            };
            
            // Calculate totals
            formData.subtotal = formData.quantity * formData.unitPrice;
            formData.iva = formData.subtotal * 0.16;
            formData.total = formData.subtotal + formData.iva;
            
            // Generate PDF
            console.log('üìÑ Calling generatePDF with data:', formData);
            try {
                generatePDF(formData);
                console.log('‚úÖ PDF generated successfully');
            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                alert('Error al generar PDF: ' + error.message);
            }
            
            // Show success message
            successAlert.classList.remove('hidden');
            setTimeout(() => {
                successAlert.classList.add('hidden');
            }, 5000);
            
            // Reset form
            form.reset();
            selectedClient = null;
            document.getElementById('clientName').value = '';
            document.getElementById('clientRFC').value = '';
            document.getElementById('clientLocation').value = '';
            document.getElementById('clientZona').value = '';
            document.getElementById('clientSubzona').value = '';
            document.getElementById('clientSitio').value = '';
            document.getElementById('clientSegmento').value = '';
            document.getElementById('clientInfoCard').classList.add('hidden');
            clientSearchInput.value = '';
            updatePreview();
        });
        
        // PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => console.log('Service Worker registered'))
                .catch(error => console.log('Service Worker registration failed:', error));
        }
        
        // PWA Install prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const closeInstallPromptBtn = document.getElementById('closeInstallPrompt');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });
        
        installPrompt.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                installPrompt.classList.add('hidden');
            }
        });
        
        closeInstallPromptBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('‚ùå Install prompt closed');
            installPrompt.classList.add('hidden');
            installPrompt.style.display = 'none';
        });
    </script></script>
    <script>
        // Cliente database
        let clientDatabase = [];
        
        // Load client database
        fetch('./clientes_db.json')
            .then(response => response.json())
            .then(data => {
                clientDatabase = data;
                console.log(`Loaded ${clientDatabase.length} clients`);
            })
            .catch(error => {
                console.error('Error loading client database:', error);
            });
        
        // Form elements
        const form = document.getElementById('quoteForm');
        const quantityInput = document.getElementById('quantity');
        const unitPriceInput = document.getElementById('unitPrice');
        const clientNameInput = document.getElementById('clientName');
        const clientRFCInput = document.getElementById('clientRFC');
        const clientLocationInput = document.getElementById('clientLocation');
        const searchPriceBtn = document.getElementById('searchPriceBtn');
        const successAlert = document.getElementById('successAlert');
        
        // Preview elements
        const previewSubtotal = document.getElementById('previewSubtotal');
        const previewIVA = document.getElementById('previewIVA');
        const previewTotal = document.getElementById('previewTotal');
        
        // Update preview on input
        function updatePreview() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(unitPriceInput.value) || 0;
            
            const subtotal = quantity * unitPrice;
            const iva = subtotal * 0.16;
            const total = subtotal + iva;
            
            previewSubtotal.textContent = `$${subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            previewIVA.textContent = `$${iva.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            previewTotal.textContent = `$${total.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        
        quantityInput.addEventListener('input', updatePreview);
        unitPriceInput.addEventListener('input', updatePreview);
        
        // Search price by RFC
        searchPriceBtn.addEventListener('click', function() {
            const rfc = clientRFCInput.value.trim().toUpperCase();
            if (!rfc) {
                alert('Por favor ingresa un RFC para buscar');
                return;
            }
            
            if (clientDatabase.length === 0) {
                alert('Cargando base de datos de clientes...\nIntenta nuevamente en un momento.');
                return;
            }
            
            // Get modality
            const modality = document.querySelector('input[name="modality"]:checked').value;
            
            // Search for client with matching RFC and modality
            const matchingClients = clientDatabase.filter(c => 
                c.rfc === rfc && c.modo_entrega === modality
            );
            
            if (matchingClients.length === 0) {
                alert(`No se encontr√≥ precio para RFC: ${rfc} con modalidad ${modality}\n\nVerifica el RFC y la modalidad seleccionada.`);
                return;
            }
            
            // Use the first matching client
            const client = matchingClients[0];
            
            // Fill form fields
            clientNameInput.value = client.nombre;
            clientLocationInput.value = client.zona;
            unitPriceInput.value = client.precio.toFixed(2);
            
            // Update preview
            updatePreview();
            
            alert(`‚úÖ Cliente encontrado!\n\nNombre: ${client.nombre}\nSegmento: ${client.segmento}\nPrecio: $${client.precio.toLocaleString('es-MX', {minimumFractionDigits: 2})}`);
        });
        
        // Generate PDF function
        function generatePDF(formData) {
            console.log('üé® Starting PDF generation');
            
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            console.log('üìã jsPDF initialized');
            
            // Set font
            doc.setFont("helvetica");
            
            // Header - Red bar
            doc.setFillColor(230, 57, 70);
            doc.rect(0, 0, 210, 30, 'F');
            
            // Logo text
            doc.setFontSize(28);
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.text("CALIDRA", 20, 20);
            
            // Date and quote number
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Fecha: ${formData.date}`, 150, 15);
            doc.text(`Cotizaci√≥n N¬∫ ${formData.quoteNumber}`, 150, 22);
            
            // Client info
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text("PARA:", 20, 45);
            doc.setFont("helvetica", "normal");
            doc.text(formData.clientName, 20, 52);
            doc.text(formData.clientRFC, 20, 59);
            doc.text(formData.clientLocation, 20, 66);
            
            // Product table header
            const tableTop = 85;
            doc.setFillColor(230, 57, 70);
            doc.rect(20, tableTop, 170, 10, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("Cantidad", 25, tableTop + 7);
            doc.text("Producto", 55, tableTop + 7);
            doc.text("Precio Unit.", 130, tableTop + 7);
            doc.text("Total", 165, tableTop + 7);
            
            // Product row
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            const productTop = tableTop + 15;
            doc.text(`${formData.quantity} Ton`, 25, productTop);
            doc.text("Hidr√≥xido de calcio", 55, productTop);
            doc.text("envasado en sacos de 25 kg", 55, productTop + 5);
            doc.text(`$${formData.unitPrice.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 130, productTop);
            doc.text(`$${formData.subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 165, productTop);
            
            // Totals
            const totalsTop = productTop + 20;
            doc.setFont("helvetica", "bold");
            doc.text("Subtotal:", 130, totalsTop);
            doc.text(`$${formData.subtotal.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 165, totalsTop);
            doc.text("IVA (16%):", 130, totalsTop + 7);
            doc.text(`$${formData.iva.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 165, totalsTop + 7);
            
            doc.setFillColor(230, 57, 70);
            doc.rect(130, totalsTop + 10, 60, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text("TOTAL:", 133, totalsTop + 16);
            doc.text(`$${formData.total.toLocaleString('es-MX', {minimumFractionDigits: 2})}`, 165, totalsTop + 16);
            
            // Notes
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.text("NOTAS:", 20, totalsTop + 35);
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(9);
            const modalityText = formData.modality === 'EXW' 
                ? 'Precio para recoger en planta CALERAS DE LA LAGUNA'
                : 'Precio incluye entrega en el domicilio registrado';
            doc.text(`‚Ä¢ ${modalityText}`, 25, totalsTop + 42);
            doc.text("‚Ä¢ Las programaciones deben ser con anticipaci√≥n m√≠nima de 72 hrs", 25, totalsTop + 48);
            doc.text("‚Ä¢ El peso del super saco es aproximado y puede variar", 25, totalsTop + 54);
            doc.text("‚Ä¢ La factura se genera con respecto al peso en la remisi√≥n", 25, totalsTop + 60);
            
            // Footer
            doc.setFont("helvetica", "italic");
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("Documento generado autom√°ticamente por Cotizador Calidra", 105, 280, { align: 'center' });
            
            // Save PDF
            doc.save(`Cotizacion_${formData.quoteNumber}_${formData.clientRFC}.pdf`);
        }
        
        // Form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('üìù Form submit triggered');
            
            // Validar que se haya seleccionado un cliente
            const clientName = document.getElementById('clientName').value;
            const clientRFC = document.getElementById('clientRFC').value;
            
            if (!clientName || !clientRFC) {
                alert('‚ö†Ô∏è Por favor busca y selecciona un cliente antes de generar la cotizaci√≥n');
                return;
            }
            
            // Validar cantidad
            const quantity = parseFloat(quantityInput.value);
            if (!quantity || quantity <= 0) {
                alert('‚ö†Ô∏è Por favor ingresa una cantidad v√°lida');
                quantityInput.focus();
                return;
            }
            
            const formData = {
                clientName: clientNameInput.value,
                clientRFC: clientRFCInput.value.toUpperCase(),
                clientLocation: clientLocationInput.value,
                quantity: parseFloat(quantityInput.value),
                unitPrice: parseFloat(unitPriceInput.value),
                modality: document.querySelector('input[name="modality"]:checked').value,
                date: new Date().toLocaleDateString('es-MX', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                }),
                quoteNumber: 'GE-' + String(Math.floor(Math.random() * 9999) + 1).padStart(4, '0')
            };
            
            // Calculate totals
            formData.subtotal = formData.quantity * formData.unitPrice;
            formData.iva = formData.subtotal * 0.16;
            formData.total = formData.subtotal + formData.iva;
            
            // Generate PDF
            console.log('üìÑ Calling generatePDF with data:', formData);
            try {
                generatePDF(formData);
                console.log('‚úÖ PDF generated successfully');
            } catch (error) {
                console.error('‚ùå Error generating PDF:', error);
                alert('Error al generar PDF: ' + error.message);
            }
            
            // Show success message
            successAlert.classList.remove('hidden');
            setTimeout(() => {
                successAlert.classList.add('hidden');
            }, 5000);
            
            // Reset form
            form.reset();
            updatePreview();
        });
        
        // PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => console.log('Service Worker registered'))
                .catch(error => console.log('Service Worker registration failed:', error));
        }
        
        // PWA Install prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('installPrompt');
        const closeInstallPromptBtn = document.getElementById('closeInstallPrompt');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installPrompt.classList.remove('hidden');
        });
        
        installPrompt.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
                installPrompt.classList.add('hidden');
            }
        });
        
        closeInstallPromptBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('‚ùå Install prompt closed');
            installPrompt.classList.add('hidden');
            installPrompt.style.display = 'none';
        });
        
        // Auto-uppercase RFC
        clientRFCInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
        
        // Modality change - clear price if searching by RFC
        document.querySelectorAll('input[name="modality"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Optionally clear price when modality changes
                // unitPriceInput.value = '';
                // updatePreview();
            });
        });
    </script>
</body>
</html>